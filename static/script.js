class K{constructor(){this.i=document.getElementById('searchInput');this.r=document.getElementById('results');this.s=document.getElementById('searchStatus');this.m=document.getElementById('contentModal');this.t=document.getElementById('modalTitle');this.c=document.getElementById('modalContent');this.x=document.getElementById('closeModal');this.o=null;this.sel=0;this.init()}init(){this.i.oninput=()=>this.h();this.x.onclick=()=>this.hide();this.m.onclick=e=>e.target===this.m&&this.hide();onkeydown=e=>this.key(e);this.restore()}key(e){if(e.key=='Escape'){this.hide();return}if(e.target!=this.i)return;const rs=this.r.querySelectorAll('.result');if(!rs.length)return;if(e.key=='ArrowDown'){e.preventDefault();this.sel=Math.min(this.sel+1,rs.length-1);this.hl()}else if(e.key=='ArrowUp'){e.preventDefault();this.sel=Math.max(this.sel-1,0);this.hl()}else if(e.key=='Enter'&rs[this.sel]){e.preventDefault();rs[this.sel].click()}}hl(){const rs=this.r.querySelectorAll('.result');rs.forEach((r,i)=>r.classList.toggle('selected',i==this.sel))}restore(){const u=new URL(location);const q=u.searchParams.get('q');if(q){this.i.value=q;this.h()}}h(){clearTimeout(this.o);const q=this.i.value.trim();if(!q){this.w();this.s.textContent='ready';return}this.s.textContent='analyzing...';this.o=setTimeout(()=>this.p(q),300)}async p(q){try{const r=await fetch(`/search?q=${encodeURIComponent(q)}`);const d=await r.json();this.d(d,q)}catch(e){this.s.textContent='error'}finally{this.s.textContent='ready'}}d(r,q){this.sel=0;if(!r.length){this.r.innerHTML=`<div class="no-results"><h3>no results</h3><p>try different terms</p></div>`;history.replaceState({},'','/');return}this.r.innerHTML=r.map(x=>`<div class="result" onclick="k.show('${x.file}')"><div class="result-title">${this.e(x.title)}</div><div class="result-content">${this.e(x.content)}</div><div class="result-meta"><span>${x.file}</span><span class="similarity">${Math.round(x.similarity*100)}%</span></div></div>`).join('');this.hl();history.replaceState({},'',`?q=${encodeURIComponent(q)}`)}w(){this.r.innerHTML=`<div class="welcome"><h3>semantic search</h3><p>contextual understanding</p><div class="features"><span class="feature">ai-powered</span><span class="feature">instant</span><span class="feature">private</span></div></div>`}async show(f){try{const r=await fetch(`/content/${encodeURIComponent(f)}`);const d=await r.json();if(d.error)return;this.t.textContent=d.title;this.c.innerHTML=d.content;this.m.style.display='block';document.body.style.overflow='hidden'}catch(e){}}hide(){this.m.style.display='none';document.body.style.overflow=''}e(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}}const k=new K();

function init(){const{floor:f,random:r}=Math;const s=document.querySelector('.circuit-bg');if(!s)return;const z=25,l=30,st='rgba(40,40,40,0.12)',bg='rgba(40,40,40,0.06)';const{width:w,height:h}=document.body.getBoundingClientRect();s.setAttribute('width',w);s.setAttribute('height',h);const rows=f(h/z),cols=f(w/z);let av=f(rows*cols);const cells=[],map={},wires=[],dirs=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];class C{constructor(x,y){this.x=x;this.y=y;this.a=1;this.d=f(r()*8)}}class W{constructor(c){this.c=[c];c.a=0;av--}v(c,d){if([0,2,4,6].includes(d))return 1;const k=`${c.x},${c.y}`;if(d===1)return(map[`${c.x},${c.y-1}`]?.a??1)&(map[`${c.x+1},${c.y}`]?.a??1);if(d===3)return(map[`${c.x+1},${c.y}`]?.a??1)&(map[`${c.x},${c.y+1}`]?.a??1);if(d===5)return(map[`${c.x-1},${c.y}`]?.a??1)&(map[`${c.x},${c.y+1}`]?.a??1);if(d===7)return(map[`${c.x-1},${c.y}`]?.a??1)&(map[`${c.x},${c.y-1}`]?.a??1);return 0}g(){while(this.c.length<l){const last=this.c[this.c.length-1];const tries=r()<.5?[0,1,-1]:[0,-1,1];while(tries.length){let d=last.d+tries.splice(f(r()**2.5*tries.length),1)[0];d=d<0?8+d:d%8;const dir=dirs[d];const x=last.x+dir[0],y=last.y+dir[1],i=y*cols+x;const n=i>=0&i<cells.length?cells[i]:0;if(x<0|x>=cols|y<0|y>=rows|!n|!n.a|!this.v(last,d))continue;n.a=0;n.d=d;av--;this.c.push(n);break}if(!tries.length)break}}draw(){const p=document.createElementNS('http://www.w3.org/2000/svg','path');const c1=document.createElementNS('http://www.w3.org/2000/svg','circle');const c2=document.createElementNS('http://www.w3.org/2000/svg','circle');let d='';const sz=z,rad=r()*(sz/8)+sz/16;c1.setAttribute('r',rad);c2.setAttribute('r',rad);c1.setAttribute('stroke',st);c2.setAttribute('stroke',st);c1.setAttribute('stroke-width',rad/6);c2.setAttribute('stroke-width',rad/4);const fill=r()>.7;c1.setAttribute('fill',fill?st:'transparent');c2.setAttribute('fill',fill?st:'transparent');for(let i=0;i<this.c.length;i++){const cur=this.c[i];if(!i){d+=`M ${cur.x*sz+sz/2} ${cur.y*sz+sz/2}`;c1.setAttribute('cx',cur.x*sz+sz/2);c1.setAttribute('cy',cur.y*sz+sz/2)}d+=` L ${cur.x*sz+sz/2} ${cur.y*sz+sz/2}`;if(i===this.c.length-1){c2.setAttribute('cx',cur.x*sz+sz/2);c2.setAttribute('cy',cur.y*sz+sz/2)}}p.setAttribute('d',d);p.setAttribute('fill','none');p.setAttribute('stroke',st);p.setAttribute('stroke-width',rad*1.5);const anim=r()>.8;if(anim){const len=p.getTotalLength?p.getTotalLength():100;p.style.cssText=`--len:${len};--len-1:${-len};--len_add_bloomLen:${len+8};--animate-time:${(len/40).toFixed(1)}s`;const pb=p.cloneNode();pb.setAttribute('stroke',bg);s.appendChild(pb);p.classList.add('animated-path-repeat')}else p.classList.add('animated-path-once');s.appendChild(p);if(r()>.7)s.appendChild(c1);if(r()>.7)s.appendChild(c2)}}for(let y=0;y<rows;y++)for(let x=0;x<cols;x++){const cell=new C(x,y);cells.push(cell);map[`${x},${y}`]=cell}const target=Math.min(40,f(av*.3));while(wires.length<target&av>0){const cell=cells[f(r()*cells.length)];if(!cell.a)continue;const wire=new W(cell);wires.push(wire);wire.g();wire.draw()}}setTimeout(init,100);
